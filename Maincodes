package org.example.service;

import org.example.model.ReportData;
import org.example.repository.ReportRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import jakarta.annotation.PostConstruct;
import java.io.*;
import java.nio.charset.StandardCharsets;

@Service
public class ReportService {

    @Autowired
    private ReportRepository reportRepository;

    @PostConstruct
    public void loadCsvData() {
        String filePath = "C:/output/merged_report.csv"; // update path accordingly

        try (BufferedReader br = new BufferedReader(new InputStreamReader(new FileInputStream(filePath), StandardCharsets.UTF_8))) {
            String line;
            boolean isHeader = true;

            while ((line = br.readLine()) != null) {
                if (isHeader) { // skip header
                    isHeader = false;
                    continue;
                }

                String[] fields = line.split(",", -1); // keep empty columns too

                ReportData data = new ReportData();
                data.setCrsCode(fields.length > 0 ? fields[0].trim() : null);
                data.setRegistrationAddress(fields.length > 1 ? fields[1].trim() : null);
                data.setRegAddressCountry(fields.length > 2 ? fields[2].trim() : null);
                data.setSiteBnpp(fields.length > 3 ? fields[3].trim() : null);
                data.setSiteCountry(fields.length > 4 ? fields[4].trim() : null);
                data.setSiteStatus(fields.length > 5 ? fields[5].trim() : null);
                data.setKycSegment(fields.length > 6 ? fields[6].trim() : null);
                data.setRicCodeDesc(fields.length > 7 ? fields[7].trim() : null);

                reportRepository.save(data);
            }
        } catch (IOException e) {
            e.printStackTrace(); // Replace with proper logging if needed
        }
    }
}
