package org.example.controller;

import jakarta.annotation.PostConstruct;
import org.example.model.ExportData;
import org.example.model.MergedEntity;
import org.example.repository.ExportDataRepository;
import org.example.service.MergedEntityService;
import org.example.util.CsvExportUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;

import java.util.List;

@Controller
public class ExportDataController {

    @Autowired
    private ExportDataRepository exportDataRepository;

    @Autowired
    private MergedEntityService mergedEntityService;

    // Step 1: Insert data at app start (once)
    @PostConstruct
    public void insertMergedEntities() {
        List<MergedEntity> mergedEntityList = mergedEntityService.getMergedEntityList();
        CsvExportUtil util = new CsvExportUtil(exportDataRepository);
        util.saveToDatabase(mergedEntityList);
    }

    // Step 2: Show table in browser
    @GetMapping("/export-data")
    public String showExportData(Model model) {
        List<ExportData> exportDataList = exportDataRepository.findAll();
        model.addAttribute("exportDataList", exportDataList);
        return "export-data"; // maps to export-data.html in templates
    }
}
