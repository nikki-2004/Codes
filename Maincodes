package org.example.util;

import org.example.model.*;
import org.example.repository.ExportDataRepository;
import org.springframework.stereotype.Component;

import java.util.List;

@Component
public class CsvExportUtil {

    private final ExportDataRepository exportDataRepository;

    public CsvExportUtil(ExportDataRepository exportDataRepository) {
        this.exportDataRepository = exportDataRepository;
    }

    public void saveToDatabase(List<MergedEntity> mergedEntities) {
        for (MergedEntity entity : mergedEntities) {
            ExportData exportData = new ExportData();

            exportData.setCrsCode(entity.getCrsCode());
            exportData.setRegAddress(entity.getRegistrationAddress() != null ? entity.getRegistrationAddress().getFullAddress() : null);
            exportData.setRegCountry(entity.getRegistrationAddress() != null ? entity.getRegistrationAddress().getCountry() : null);

            if (entity.getKycSites() != null && !entity.getKycSites().isEmpty()) {
                KycSite site = entity.getKycSites().get(0);
                exportData.setSiteBnpp(site.getSiteEntity());
                exportData.setSiteCountry(site.getSiteCountry());
                exportData.setSiteStatus(site.getSiteStatus());
            }

            exportData.setKycSegment(entity.getKycSegment());
            exportData.setRic(entity.getRic());

            exportDataRepository.save(exportData);
        }

        System.out.println(">>> Data saved to DB.");
    }
}
