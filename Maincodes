package org.example.service;

import org.example.model.ReportData;
import org.example.repository.ReportDataRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import jakarta.annotation.PostConstruct;
import java.io.*;
import java.nio.file.Files;
import java.nio.file.Paths;

@Service
public class CsvLoaderService {

    @Autowired
    private ReportDataRepository repository;

    @PostConstruct
    public void loadCsvData() {
        String filePath = "C:/output/merged_report.csv"; // adjust path
        try (BufferedReader reader = Files.newBufferedReader(Paths.get(filePath))) {
            String line;
            boolean isFirstLine = true;
            while ((line = reader.readLine()) != null) {
                if (isFirstLine) {
                    isFirstLine = false; // skip header
                    continue;
                }

                String[] tokens = line.split(";");
                if (tokens.length >= 8) {
                    ReportData data = new ReportData();
                    data.setCrsCode(tokens[0]);
                    data.setRegistrationAddress(tokens[1]);
                    data.setRegAddressCountry(tokens[2]);
                    data.setSiteBnpp(tokens[3]);
                    data.setSiteCountry(tokens[4]);
                    data.setSiteStatus(tokens[5]);
                    data.setKycSegment(tokens[6]);
                    data.setRicCodeDesc(tokens[7]);

                    repository.save(data);
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
